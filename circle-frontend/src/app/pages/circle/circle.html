<!--
  Circle Page Template
  
  Shows circle info and either join form (if not member) or member view (if member).
  This combines the old join-circle and circle pages into one.
-->

<mat-card>
  <!-- Loading state -->
  @if (isLoading()) {
    <mat-card-content style="text-align: center; padding: 48px;">
      <mat-spinner></mat-spinner>
      <p style="margin-top: 16px;">Loading circle...</p>
    </mat-card-content>
  }

  <!-- Error state -->
  @if (error()) {
    <mat-card-header>
      <mat-card-title>
        <mat-icon color="warn">error</mat-icon>
        Circle Not Found
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>{{ error() }}</p>
    </mat-card-content>
  }

  <!-- Circle loaded successfully -->
  @if (circle() && !isLoading() && !error()) {
    <mat-card-header>
      <mat-card-title>
        <mat-icon color="primary">group</mat-icon>
        {{ circle()?.name }}
      </mat-card-title>
      <mat-card-subtitle>
        Created {{ circle()?.createdAtFormatted }} â€¢ {{ circle()?.userCount }} members
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Show current members -->
      <div style="margin-bottom: 24px;">
        <h3>Members</h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          @for (user of circle()?.users; track user.id) {
            <mat-card style="padding: 8px 12px; margin: 4px;">
              <span>{{ user.name }}</span>
              <small style="color: #666; margin-left: 8px;">
                Joined {{ formatDate(user.joinedAt) }}
              </small>
            </mat-card>
          }
        </div>
      </div>

      <!-- If user is NOT a member, show join options -->
      @if (!isUserMember()) {
        <div style="border-top: 1px solid #e0e0e0; padding-top: 24px;">
          <h3>Join This Circle</h3>
          
          <!-- Option 1: Are you one of these existing users? -->
          @if (circle()?.users && circle()!.users.length > 0) {
            <div style="margin-bottom: 24px;">
              <h4>Are you one of these people?</h4>
              <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                @for (user of circle()?.users; track user.id) {
                  <button 
                    mat-stroked-button 
                    (click)="selectExistingUser(user)"
                    [disabled]="isJoining()"
                    style="margin: 4px;"
                  >
                    <mat-icon>person</mat-icon>
                    {{ user.name }}
                  </button>
                }
              </div>
            </div>
          }
          
          <!-- Option 2: Create new user -->
          <div>
            <h4>Or create a new identity:</h4>
            <form [formGroup]="joinForm" (ngSubmit)="onJoin()">
              <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
                <mat-label>Your Name</mat-label>
                <input 
                  matInput 
                  formControlName="userName"
                  placeholder="e.g., John Doe"
                  maxlength="50"
                >
                <mat-hint>This is how others will see you in the circle</mat-hint>
                
                <!-- Show validation errors -->
                @if (getFieldError('userName')) {
                  <mat-error>{{ getFieldError('userName') }}</mat-error>
                }
                
                <!-- Show name taken error -->
                @if (joinForm.get('userName')?.value && isNameTaken(joinForm.get('userName')?.value)) {
                  <mat-error>This name is already taken in this circle</mat-error>
                }
              </mat-form-field>

              <button 
                mat-raised-button 
                color="primary" 
                type="submit"
                [disabled]="isJoining() || !joinForm.valid || isNameTaken(joinForm.get('userName')?.value || '')"
                style="margin-top: 16px;"
              >
                @if (isJoining()) {
                  <mat-spinner diameter="20"></mat-spinner>
                  Joining Circle...
                } @else {
                  <ng-container>
                    <mat-icon>person_add</mat-icon>
                    Join as New User
                  </ng-container>
                }
              </button>
            </form>
          </div>
        </div>
      }

      <!-- If user IS a member, show member view -->
      @if (isUserMember()) {
        <div style="border-top: 1px solid #e0e0e0; padding-top: 24px;">
          <div style="text-align: center; padding: 24px; background-color: #f5f5f5; border-radius: 8px;">
            <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #666;">construction</mat-icon>
            <h3>Welcome Back!</h3>
            <p>You're a member of this circle. Resource sharing features will be implemented in Phase 3.</p>
            <p style="margin-top: 16px;">
              <strong>Share this circle:</strong><br>
              <code>{{ circle()?.shareableUrl }}</code>
            </p>
          </div>
        </div>
      }
    </mat-card-content>
  }
</mat-card>